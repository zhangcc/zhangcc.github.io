---
layout: postlayout
title: 【转】深入IIS和ASP.NET--IIS与ASP.NET简要
description: 本系列旨在记录IIS和ASP.NET内部原理，主要来源于网络上一些优秀的文章转载。本篇回顾IIS原理以及请求是如何进入ASP.NET框架了
thumbimg: aspnet.png
categories: [Web, ASP.NET]
tags: [IIS]
---

<p>原文地址：<a title="http://www.cnblogs.com/BlueGeek/archive/2013/01/23/2872732.html" href="http://www.cnblogs.com/BlueGeek/archive/2013/01/23/2872732.html">http://www.cnblogs.com/BlueGeek/archive/2013/01/23/2872732.html</a></p> <p>以前写过ASP.Net的一些小东西，也像模像样在IIS上部署站点，设置权限、建立目录、选择.Net版本等，弄得不亦乐乎，但是对于ASP.Net与IIS之间是如何协同工作的，却一无所知，今天在博客园转了圈，看到了相关文章，略有感悟，做如下记录。 <p><strong>一、基本概念理解：</strong> <p>什么是IIS? <p>IIS（Internet Information Server）是微软Web Server的一种，用来配置ASP.Net。IIS拥有自己的ASP.Net处理引擎来处理请求，因此当一个请求来时，IIS处理请求并返回内容。 <p><img alt="" src="http://pic004.cnblogs.com/news/201204/20120420_135410_2.JPG"> <p>什么是<strong>工作进程（worker Process）</strong>，什么是<strong>应用程序池(Application Pool)</strong>？ <p><strong>工作进程：工作进程（w3wp.exe）是ASP.Net应用程序的心脏。</strong> <p>&nbsp;&nbsp;&nbsp; ASP.Net应用程序在工作进程中运行，工作进程管理并响应所有的请求； <p>&nbsp;&nbsp;&nbsp; ASP.Net的所有功能都运行在工作进程之下； <p>&nbsp;&nbsp;&nbsp; 当请求来临时，工作进程会生成Request和Response等的相关信息； <p><strong>应用程序池：应用程序池是工作进程的容器。</strong> <p><strong></strong>　　　　　应用程序池通常用来隔离不同配置（如：.Net Framework的版本）的工作进程； <p>　　　　　　　当一个工作进程关闭或者进程回收资源的时候，不会影响其他池中的工作进程； <p>IIS6.0的基本结构和重要文件 <p>　　如果我们看一下IIS 6.0的结构，就会发现，可以把它分成两部分： <p>　　1、内核模块（Kernel Mode） <p>　　2、用户模块（User Mode） <p>　　内核模式是从IIS 6.0被引入的，<strong>它包含了一个叫HTTP.SYS的文件，每当请求进来时，会首先触发该文件的响应</strong>。 <p><img alt="" src="http://pic004.cnblogs.com/news/201204/20120420_135411_4.JPG"> <p><strong>二、IIS处理一个请求的详细步骤：</strong> <p><strong></strong>&lt;1&gt;HTTP.SYS文件负责把请求传入相应的应用程序池中。 <p><img alt="" src="http://pic004.cnblogs.com/news/201204/20120420_135411_4.JPG"> <p>　　　重要细节剖析： <p>　　　&lt;a&gt;　HTTP.SYS文件负责把请求传入相应的应用程序池中。但HTTP.SYS如何知道应传给哪个应用程序池呢？当然不是随机抽取，每当创建一个应用程序池，该池的ID就会生成并在HTTP.SYS文件中注册，因此该文件才能确定将请求往哪传。 <p><img alt="" src="http://pic004.cnblogs.com/news/201204/20120420_135412_5.JPG"> <p>　　　&lt;b&gt;请求从HTTP.SYS传入应用程序池的过程：在IIS的用户模块中，通过<em>Web Admin Services (WAS)</em>从HTTP.SYS接收请求，并传入相应的应用程序池中。 <p><img alt="" src="http://pic004.cnblogs.com/news/201204/20120420_135414_6.JPG"> <p>　　&lt;2&gt;应用程序池接收到请求后的动作： <p>　　当应用程序池接收到请求，会接着传给工作进程（w3wp.exe），该进程检查来请求的URL后缀以确定加载哪个ISAPI扩展。ASP.NET加载时会附带自己的ISAPI扩展（aspnet_isapi.dll），以便在IIS中映射。 <p><img alt="" src="http://pic004.cnblogs.com/news/201204/20120420_135415_7.JPG"> <p>　　重要细节剖析： <p>　　&lt;a&gt;一旦工作进程加载了aspnet_isapi.dll, 就会构造一个HttpRuntime类，该类是应用程序的入口，通过ProcessRequest方法处理请求。 <p>&nbsp;&nbsp;&nbsp; &lt;b&gt;一旦这个方法被调用，一个HttpContext的实例就产生了。可通过HTTPContext.Current获取到这个实例，且该实例会在整个生命周期中存活，我们通过它可以获取到一些常用对象，如Request，Response，Session 等。 <p>　　&lt;c&gt;之后HttpRuntime会通过HttpApplicationFactory类加载一个HttpApplication对象。每一次请求都要穿过一堆HttpModule到达HttpHandler，以便被响应。而这些HttpModule就被配置在HttpApplication中。 <p>　　&lt;d&gt;有一个概念叫“Http管道”，被叫做管道是因为它包含了一系列的HttpModule，这些HttpModule拦截请求并将其导向相应的HttpHandler。我们也可自定义HttpModule，以便在请求响应之间做点特别的处理。 <p><img alt="" src="http://pic004.cnblogs.com/news/201204/20120420_135419_10.JPG"> <p>HttpHandler是“Http管道”的终点。所有请求穿过HttpModule需抵达相应的HttpHandler，然后HttpHandler根据请求资源，产生并输出内容。也正因此，我们请求任何aspx页面才会得到响应的Html内容。 <p><strong>三、IIS处理过程总结</strong> <p><strong></strong>&lt;1&gt;整体过程图 <p><img alt="" src="http://pic004.cnblogs.com/news/201204/20120420_135422_11.JPG"> <p>　　&lt;2&gt;大致描述： <p>　　　　每当请求Web服务器上的某些信息时，该请求首先会到达Http.SYS, 然后Http.SYS将其发送到相应的应用程序池，应用程序池传给工作进程并加载ISAPI扩展，然后HttpRuntime对象会被创建，并通过HttpModule和HttpHandler处理请求。最后，ASP.NET页面生命周期就开始了。
